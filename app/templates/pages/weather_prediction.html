{% extends 'layouts/base_auth.html' %}

{% block title %}
Weather Prediction
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label for="locationInput">Choose Location</label>
            <select id="locationInput" class="form-control">
                <option value="Chittagong" selected>Chittagong</option>
                <option value="Dhaka">Dhaka</option>
                <option value="Rajshahi">Rajshahi</option>
                <option value="Khulna">Khulna</option>
                <option value="Sylhet">Sylhet</option>
                <option value="Barisal">Barisal</option>
                <option value="Rangpur">Rangpur</option>
                <option value="Mymensingh">Mymensingh</option>
            </select>
        </div>
    </div>
</div>

<div id="weatherCard" class="card mt-4" style="display: none;">
    <div class="card-header">
        <h4 id="weatherLocation"></h4>
    </div>
    <div class="card-body">
        <div class="row d-flex align-items-stretch">

            <!-- Weather Icon Card -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 text-center bg-info text-white">
                    <img id="weatherIcon" class="card-img-top" alt="Weather Icon">
                    <div class="card-body">
                        <p class="card-text" id="weatherDescription"></p>
                    </div>
                </div>
            </div>

            <!-- Temperature Card -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 text-center bg-warning text-dark">
                    <div class="card-body">
                        <h5 class="card-title">Temperature</h5>
                        <p id="weatherTemp"></p> <span>Â°C</span>
                    </div>
                </div>
            </div>

            <!-- Humidity Card -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 text-center bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Humidity</h5>
                        <p id="weatherHumidity"></p> <span>%</span>
                    </div>
                </div>
            </div>

            <!-- Wind Speed Card -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 text-center bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Wind Speed</h5>
                        <p id="weatherWind"></p> <span>m/s</span>
                    </div>
                </div>
            </div>

            <!-- Pressure Card -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 text-center bg-secondary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Pressure</h5>
                        <p id="weatherPressure"></p> <span>hPa</span>
                    </div>
                </div>
            </div>

            <!-- Cloudiness Card -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 text-center bg-dark text-white">
                    <div class="card-body">
                        <h5 class="card-title">Cloudiness</h5>
                        <p id="weatherCloud"></p> <span>%</span>
                    </div>
                </div>
            </div>

            <!-- Sunrise and Sunset Cards -->
            <div class="col-md-3 mb-3">
                <div class="card h-100 text-center bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Sunrise</h5>
                        <p id="weatherSunrise"></p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card h-100 text-center bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Sunset</h5>
                        <p id="weatherSunset"></p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Load weather for Chittagong by default
        fetchWeather("Chittagong");

        // Handle location change
        $("#locationInput").on("change", function () {
            const location = $(this).val();
            if (location) {
                fetchWeather(location);
            }
        });

        function fetchWeather(location) {
            $.ajax({
                url: "/api/weather",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ location: location }),
                success: function (response) {
                    $("#weatherLocation").text(response.location);
                    $("#weatherDescription").text(response.description);
                    $("#weatherTemp").text(response.temperature);
                    $("#weatherHumidity").text(response.humidity);
                    $("#weatherWind").text(response.wind_speed);
                    $("#weatherPressure").text(response.pressure);
                    $("#weatherCloud").text(response.cloudiness);
                    $("#weatherSunrise").text(formatTime(response.sunrise));
                    $("#weatherSunset").text(formatTime(response.sunset));
                    $("#weatherIcon").attr("src", `http://openweathermap.org/img/wn/${response.icon}@2x.png`);
                    $("#weatherCard").show();
                },
                error: function () {
                    alert("Failed to load weather data. Please try again.");
                }
            });
        }

        // Helper to format time from Unix timestamp (in seconds)
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString();
        }
    });
</script>

<!-- You can add select2 for a searchable city input -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('#locationInput').select2();
    });
</script>
{% endblock %}
